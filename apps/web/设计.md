这是基于您最新要求（使用图标作为头像）修改后的完整技术方案设计文档。

---

# 项目设计文档：HVAC 智能对话审阅系统 (Smart Transcript Reviewer)

## 1. 项目概述 (Executive Summary)

本项目旨在构建一个基于 Next.js 的静态网页，用于展示 HVAC 技术人员与客户的销售/维修对话记录。
核心交互目标是模拟 **Microsoft Word / Google Docs 的高级审阅体验**，结合现代化的 UI 设计：

* **左侧**：以“线性剧本流”形式展示对话，采用直观的**图标头像**区分角色。
* **右侧**：显示业务洞察批注（Annotations），位置与对话上下文精确对齐。
* **视觉**：通过语义化颜色高亮，直观展示销售策略（如“痛点挖掘”、“交叉销售”等）。

---

## 2. 技术架构 (Technical Architecture)

* **Framework**: Next.js 14+ (App Router)
* **Rendering**: SSG (Static Site Generation) - 页面内容在构建时由 JSON 注入。
* **Styling**: Tailwind CSS (用于原子化样式与响应式布局)。
* **Language**: TypeScript (严格类型安全)。
* **Icons**: **Lucide React** (用于头像和界面图标)。
* **State Management**: React Context 或 Local State (用于处理 hover 高亮联动)。

---

## 3. 视觉与布局规范 (Visual Specifications)

### 3.1 整体布局 (The Canvas)

页面采用**响应式双栏布局**：

* **Header**: 顶部固定或随动，展示 Meta 数据。
* **Desktop (>1024px)**:
* **Main Column (60-65%)**: 左侧，展示对话流。
* **Sidebar Column (35-40%)**: 右侧，展示批注卡片。


* **Mobile (<1024px)**:
* 单栏布局。批注不再显示在侧边，而是以内嵌折叠块（Inline Details）的形式出现在相关对话下方。



### 3.2 对话流风格：线性剧本 (Linear Script Style)

摒弃左右气泡，采用垂直堆叠列表结构，强调专业文档感。

* **排列**: 所有对话行均为 **左对齐**。
* **结构**: `Flexbox` 布局，左侧为固定宽度的头像列 (Gutter)，右侧为自适应的内容列。
* **背景色**:
* **Technician**: 纯白背景 (`bg-white`)。
* **Homeowner**: 极淡灰背景 (`bg-slate-50/50`)，形成微弱的视觉节奏感。



### 3.3 批注风格：Word 卡片 (Annotation Cards)

* **形态**: 悬浮卡片，带有阴影 (`shadow-sm`)。
* **指示**: 卡片左侧有一条 4px 的实心色条，颜色对应 Category。
* **对齐**: 卡片的顶部 (`top`) 与其评论的第一行对话 (`start_line_id`) 的顶部在水平线上保持一致（若发生重叠则自动顺延）。

---

## 4. Avatar 设计规范 (Avatar Specifications) - [NEW]

采用 **“圆形彩色背景 + 中心白色图标”** 的形式，高辨识度且风格现代。

| 角色 | 图标 (Lucide React) | 语义 | 配色方案 (Tailwind) |
| --- | --- | --- | --- |
| **Technician** | `<Wrench />` (扳手) | 专业、维修、技术 | **蓝色系**: `bg-blue-600 text-white` |
| **Homeowner** | `<User />` (用户) | 客户、居住者、人 | **琥珀色系**: `bg-amber-500 text-white` |

* **尺寸规范**:
* 圆形容器: `w-10 h-10` (40x40px)
* 内部图标: `size={20}` (20x20px)



---

## 5. 颜色系统 (Color System)

基于 JSON 中的 `category` 字段定义的语义化配色方案。

| Category (Key) | 色系 (Tailwind) | 视觉含义 |
| --- | --- | --- |
| **Introduction** | `Blue` (blue-500) | 流程、开场、寒暄 |
| **Problem Diagnosis** | `Red` (red-500) | 痛点、故障、警告 |
| **Solution Explanation** | `Indigo` (indigo-500) | 技术方案、产品教育 |
| **Upsell Attempts** | `Amber` (amber-500) | 销售机会、升级建议 |
| **Maintenance Plan Offer** | `Emerald` (emerald-500) | 会员服务、长期绑定 |
| **Closing & Thank You** | `Purple` (purple-500) | 成交、支付、收尾 |
| **Sales Insights** | `Pink` (pink-500) | 销售技巧分析 |
| *Default* | `Gray` (gray-400) | 通用/其他 |

**应用位置**:

1. **卡片边框**: `border-l-4 border-{color}-500`
2. **卡片背景**: `bg-{color}-50`
3. **正文高亮**: 对话正文中被批注覆盖的文字背景 `bg-{color}-100/50`

---

## 6. 数据结构定义 (TypeScript Schema)

文件路径: `src/types/schema.ts`

```typescript
// 1. 基础对话单元
export interface TranscriptItem {
  id: number;
  speaker: "Technician" | "Homeowner";
  text: string;
}

// 2. 元数据
export interface MetaData {
  call_type: string;
  overall_score: "High" | "Medium" | "Low";
  summary: string;
}

// 3. 合规清单 (保留字段，UI暂不渲染)
export interface ComplianceItem {
  step_name: string;
  description: string;
  status: string;
  quality: number;
  comment: string;
}

// 4. 批注类别枚举
export type AnnotationCategory = 
  | "Introduction"
  | "Problem Diagnosis"
  // ... (其他类别)
  | "Sales Insights";

// 5. 批注对象
export interface Annotation {
  id: number;
  start_line_id: number;
  end_line_id: number;
  category: AnnotationCategory;
  title: string;
  content: string;
}

// 6. 完整 JSON 结构
export interface TranscriptData {
  transcript: TranscriptItem[];
  meta: MetaData;
  compliance_checklist: ComplianceItem[];
  annotations: Annotation[];
}

```

---

## 7. 组件实现参考 (Component Implementation)

### MessageRow.tsx (展示图标头像)

```tsx
import { Wrench, User } from 'lucide-react'; // 引入图标

// 辅助函数：获取对应的图标和样式
const getSpeakerDetails = (speaker: string) => {
  if (speaker === "Technician") {
    return {
      icon: <Wrench size={20} />,
      style: "bg-blue-600 text-white"
    };
  }
  // Default to Homeowner
  return {
    icon: <User size={20} />,
    style: "bg-amber-500 text-white"
  };
};

// 组件内部渲染部分
const { icon, style } = getSpeakerDetails(item.speaker);

return (
  <div id={`line-${item.id}`} className="flex gap-4 mb-6 p-2 rounded-lg ...">
    
    {/* --- 左侧 Avatar 列 --- */}
    <div className="flex-shrink-0 w-12 flex justify-center">
      <div className={`
        w-10 h-10 rounded-full 
        flex items-center justify-center 
        shadow-sm select-none
        ${style} {/* 应用背景色和文字颜色 */}
      `}>
        {icon} {/* 渲染 Lucide 图标 */}
      </div>
    </div>

    {/* --- 右侧 内容列 --- */}
    <div className="flex-grow pt-1">
      {/* 名字 (小字) */}
      <div className="text-xs text-gray-400 font-semibold mb-1 uppercase tracking-wider">
        {item.speaker}
      </div>
      {/* ... 对话文本渲染 ... */}
    </div>
  </div>
);

```

---

## 8. 核心逻辑：智能对齐算法 (Alignment Logic)

(此处逻辑与之前相同，为确保文档完整性保留)

为了实现“Word 风格”且不重叠，在客户端计算位置。

**逻辑描述 (lib/alignment.ts)**:

1. 遍历所有批注。
2. 获取批注起始对话行 (`start_line_id`) 在页面中的绝对 `offsetTop`。
3. **碰撞检测**: 如果当前计算出的 `top` 值小于（上一个卡片的底部位置 + 间距），则强制将当前卡片向下推移，避免重叠。
4. 返回一个 Map，包含每个批注 ID 对应的精确 `top` 像素值，赋给右侧绝对定位的卡片。

---

## 9. 开发实施步骤 (Implementation Plan)

1. **Setup**: 初始化 Next.js 项目，安装 Tailwind。**安装 `lucide-react**`。
2. **Data Layer**: 导入 JSON，定义 Types。
3. **UI Core (Left)**:
* 开发 `Header`。
* 开发 `MessageRow`：实现线性剧本样式，并**集成 Lucide 图标作为头像**。
* 实现颜色映射工具函数。


4. **Interaction (Highlight)**: 实现文本背景高亮逻辑。
5. **UI Core (Right)**: 开发 `AnnotationCard` 和 `AnnotationSidebar`。
6. **Integration (Alignment)**: 使用 `useLayoutEffect` 和对齐算法实现左右联动。
7. **Responsive**: 处理移动端适配。